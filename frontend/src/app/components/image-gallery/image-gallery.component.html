<div class="gallery-container">
  <h2>Galerie d'Images</h2>

  <div class="controls">
    <div class="filter-section">
      <label for="classFilter">Filtrer par classe d'objet:</label>
      <select 
        id="classFilter" 
        [(ngModel)]="objectClassFilter" 
        (change)="onFilterChange()"
        class="filter-select">
        <option value="">Toutes les images</option>
        <option *ngFor="let cls of availableClasses" [value]="cls">{{ cls }}</option>
      </select>
    </div>
    <button class="refresh-button" (click)="loadImages()" [disabled]="loading">
      ğŸ”„ Actualiser
    </button>
  </div>

  <div *ngIf="loading" class="loading">
    â³ Chargement des images...
  </div>

  <div *ngIf="error" class="error-message">
    âŒ {{ error }}
  </div>

  <div *ngIf="!loading && !error">

    <div class="gallery-info">
      <p>{{ total }} image(s) au total</p>
      <p>Page {{ currentPage }} / {{ totalPages }}</p>
      <button *ngIf="selectedImages.length > 0" class="delete-selected-btn" (click)="deleteSelectedImages()">ğŸ—‘ï¸ Supprimer la sÃ©lection ({{ selectedImages.length }})</button>
    </div>

    <div *ngIf="images.length === 0" class="empty-state">
      <p>ğŸ“­ Aucune image trouvÃ©e.</p>
      <p>Uploadez des images depuis la page d'upload pour commencer.</p>
    </div>

    <div class="gallery-grid" *ngIf="images.length > 0">
      <div class="image-card" *ngFor="let image of images; let idx = index">
        <input type="checkbox" [(ngModel)]="image.selected" (change)="onImageSelectChange(image)">
        <div class="image-preview" (click)="viewImage(image)">
          <img [src]="'http://localhost:5000/download/' + image.id" 
               [alt]="image.filename"
               (error)="$event.target.src='assets/placeholder.png'">
          <div class="image-overlay">
            <span class="view-icon">ğŸ‘ï¸</span>
          </div>
        </div>
        <div class="image-info">
          <h4 class="image-title" [title]="image.filename">
            {{ image.filename.length > 20 ? (image.filename | slice:0:20) + '...' : image.filename }}
          </h4>
          <div class="image-meta">
            <span *ngIf="image.objects_count !== undefined" class="badge">
              {{ image.objects_count }} objet(s)
            </span>
            <span *ngIf="image.object_classes" class="classes">
              {{ image.object_classes.join(', ') }}
            </span>
          </div>
          <div class="image-actions">
            <button class="action-btn view-btn" (click)="viewImage(image)">ğŸ‘ï¸ Voir</button>
            <button class="action-btn descriptors-btn" (click)="viewDescriptors(image)">ğŸ“Š Descripteurs</button>
            <button class="action-btn download-btn" (click)="downloadImage(image)">â¬‡ï¸ TÃ©lÃ©charger</button>
            <button class="action-btn delete-btn" (click)="deleteImage(image)">ğŸ—‘ï¸ Supprimer</button>
            <button class="action-btn transform-btn" (click)="openTransformModal(image)">ğŸ› ï¸ Transformer</button>
          </div>
        </div>
      </div>
    <div class="pagination" *ngIf="totalPages > 1">
      <button (click)="previousPage()" [disabled]="currentPage === 1">â—€ï¸ PrÃ©cÃ©dent</button>
      <span>Page {{ currentPage }} / {{ totalPages }}</span>
      <button (click)="nextPage()" [disabled]="currentPage === totalPages">Suivant â–¶ï¸</button>
    </div>
  </div>
</div>

        <!-- Modal de transformation d'image -->
        <div *ngIf="showTransformModal" class="modal-overlay" (click)="closeTransformModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">
            <button class="close-button" (click)="closeTransformModal()">âœ•</button>
            <h3>Transformer l'image : {{ transformTarget?.filename }}</h3>
            <form (ngSubmit)="submitTransform()">
              <label>Type de transformation :</label>
              <select [(ngModel)]="transformType" name="transformType" required>
                <option value="crop">Crop</option>
                <option value="resize">Resize</option>
                <option value="rotate">Rotate</option>
                <option value="flip">Flip</option>
                <option value="brightness">Brightness/Contrast</option>
              </select>
              <div *ngIf="transformType === 'crop'">
                <label>X: <input type="number" [(ngModel)]="transformParams.x" name="cropX"></label>
                <label>Y: <input type="number" [(ngModel)]="transformParams.y" name="cropY"></label>
                <label>Width: <input type="number" [(ngModel)]="transformParams.width" name="cropWidth"></label>
                <label>Height: <input type="number" [(ngModel)]="transformParams.height" name="cropHeight"></label>
              </div>
              <div *ngIf="transformType === 'resize'">
                <label>Width: <input type="number" [(ngModel)]="transformParams.width" name="resizeWidth"></label>
                <label>Height: <input type="number" [(ngModel)]="transformParams.height" name="resizeHeight"></label>
                <label>Scale: <input type="number" step="0.01" [(ngModel)]="transformParams.scale" name="resizeScale"></label>
              </div>
              <div *ngIf="transformType === 'rotate'">
                <label>Angle (degrÃ©s): <input type="number" [(ngModel)]="transformParams.angle" name="rotateAngle"></label>
              </div>
              <div *ngIf="transformType === 'flip'">
                <label>Direction:
                  <select [(ngModel)]="transformParams.direction" name="flipDirection">
                    <option value="horizontal">Horizontal</option>
                    <option value="vertical">Vertical</option>
                    <option value="both">Both</option>
                  </select>
                </label>
              </div>
              <div *ngIf="transformType === 'brightness'">
                <label>Brightness: <input type="number" step="0.01" [(ngModel)]="transformParams.brightness" name="brightness"></label>
                <label>Contrast: <input type="number" step="0.01" [(ngModel)]="transformParams.contrast" name="contrast"></label>
              </div>
              <button type="submit">Appliquer</button>
            </form>
            <div *ngIf="transformError" class="error-message">{{ transformError }}</div>
            <div *ngIf="transformSuccess" class="success-message">Transformation rÃ©ussie !</div>
  </div>
</div>

<!-- Modal pour afficher l'image en grand -->
<div *ngIf="selectedImage && imageUrl" class="image-modal" (click)="closeImageView()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <button class="close-button" (click)="closeImageView()">âœ•</button>
    <h3>{{ selectedImage.filename }}</h3>
    <img [src]="imageUrl" [alt]="selectedImage.filename">
    <div class="modal-info">
      <p><strong>Objets dÃ©tectÃ©s:</strong> {{ selectedImage.objects_count || 0 }}</p>
      <div *ngIf="selectedImage.objects_detected && selectedImage.objects_detected.length > 0">
        <ul>
          <li *ngFor="let obj of selectedImage.objects_detected">
            {{ obj.class }} ({{ (obj.confidence * 100).toFixed(1) }}%)
          </li>
        </ul>
      </div>
    </div>
  </div>
</div>
