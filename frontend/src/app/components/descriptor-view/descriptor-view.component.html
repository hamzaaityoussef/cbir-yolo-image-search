<div class="descriptor-container">
  <div *ngIf="loading" class="loading">
    ‚è≥ Chargement des descripteurs...
  </div>

  <div *ngIf="error" class="error-message">
    ‚ùå {{ error }}
  </div>

  <div *ngIf="!loading && !error && image">
    <h2>Descripteurs visuels - {{ image.filename }}</h2>

    <div class="image-preview">
      <img [src]="'http://localhost:5000/download/' + image.id" [alt]="image.filename">
    </div>

    <div class="info-section">
      <h3>Informations g√©n√©rales</h3>
      <div class="info-grid">
        <div class="info-item">
          <strong>ID:</strong> {{ image.id }}
        </div>
        <div class="info-item">
          <strong>Nom de fichier:</strong> {{ image.filename }}
        </div>
        <div class="info-item">
          <strong>Date d'upload:</strong> {{ image.uploaded_at | date:'medium' }}
        </div>
        <div class="info-item">
          <strong>Objets d√©tect√©s:</strong> {{ image.objects_count || 0 }}
        </div>
      </div>
    </div>

    <div *ngIf="image.objects_detected && image.objects_detected.length > 0" class="objects-section">
      <h3>Objets d√©tect√©s (YOLO)</h3>
      <div class="objects-list">
        <div class="object-item" *ngFor="let obj of image.objects_detected; let i = index">
          <div class="object-header">
            <strong>{{ obj.class }}</strong>
            <span class="confidence">Confiance: {{ (obj.confidence * 100).toFixed(1) }}%</span>
          </div>
          <div class="object-bbox">
            Bounding Box: [{{ obj.bbox?.join(', ') }}]
          </div>
          <button (click)="loadObjectDescriptors(i)">Voir les descripteurs de cet objet</button>
        </div>
      </div>
    </div>

    <div class="descriptors-section">
      <div *ngIf="selectedObjectId !== null" class="object-selector">
        <h3>Descripteurs de l'objet : {{ selectedObjectClass }}</h3>
        <button class="btn-link" (click)="showImageDescriptors()">‚Üê Voir les descripteurs de l'image compl√®te</button>
      </div>
      <div *ngIf="selectedObjectId === null">
        <h3>Descripteurs visuels de l'image compl√®te</h3>
      </div>

      <div *ngIf="!descriptors && !loading" class="note">
        <p>‚ö†Ô∏è Aucun descripteur disponible pour cette {{ selectedObjectId !== null ? 'objet' : 'image' }}.</p>
      </div>

      <div *ngIf="descriptors" class="descriptors-content">
        <!-- Histogrammes RGB -->
        <div class="descriptor-category" *ngIf="descriptors.color_histogram_rgb">
          <h4>üìä Histogramme RGB</h4>
          <div class="histogram-info">
            <div class="hist-channel" *ngIf="descriptors.color_histogram_rgb.r">
              <strong>Rouge (R):</strong>
              <div class="stats">
                <span>Moyenne: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.r).mean) }}</span>
                <span>√âcart-type: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.r).std) }}</span>
                <span>Max: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.r).max) }}</span>
              </div>
              <div class="histogram-bar">
                <div class="bar" *ngFor="let val of descriptors.color_histogram_rgb.r.slice(0, 50); let i = index" 
                     [style.height.%]="val * 100" 
                     [style.background-color]="'#ff0000'"
                     [title]="'Bin ' + i + ': ' + formatNumber(val)"></div>
              </div>
            </div>
            <div class="hist-channel" *ngIf="descriptors.color_histogram_rgb.g">
              <strong>Vert (G):</strong>
              <div class="stats">
                <span>Moyenne: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.g).mean) }}</span>
                <span>√âcart-type: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.g).std) }}</span>
                <span>Max: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.g).max) }}</span>
              </div>
              <div class="histogram-bar">
                <div class="bar" *ngFor="let val of descriptors.color_histogram_rgb.g.slice(0, 50); let i = index" 
                     [style.height.%]="val * 100" 
                     [style.background-color]="'#00ff00'"
                     [title]="'Bin ' + i + ': ' + formatNumber(val)"></div>
              </div>
            </div>
            <div class="hist-channel" *ngIf="descriptors.color_histogram_rgb.b">
              <strong>Bleu (B):</strong>
              <div class="stats">
                <span>Moyenne: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.b).mean) }}</span>
                <span>√âcart-type: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.b).std) }}</span>
                <span>Max: {{ formatNumber(getHistogramStats(descriptors.color_histogram_rgb.b).max) }}</span>
              </div>
              <div class="histogram-bar">
                <div class="bar" *ngFor="let val of descriptors.color_histogram_rgb.b.slice(0, 50); let i = index" 
                     [style.height.%]="val * 100" 
                     [style.background-color]="'#0000ff'"
                     [title]="'Bin ' + i + ': ' + formatNumber(val)"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Couleurs dominantes -->
        <div class="descriptor-category" *ngIf="descriptors.dominant_colors">
          <h4>üé® Couleurs dominantes</h4>
          <div class="dominant-colors">
            <div class="color-item" *ngFor="let color of descriptors.dominant_colors; let i = index">
              <div class="color-box" [style.background-color]="rgbToHex(color[0], color[1], color[2])"></div>
              <div class="color-info">
                <strong>Couleur {{ i + 1 }}</strong>
                <div class="color-rgb">RGB({{ Math.round(color[0]) }}, {{ Math.round(color[1]) }}, {{ Math.round(color[2]) }})</div>
                <div class="color-hex">{{ rgbToHex(color[0], color[1], color[2]) }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Descripteurs de Tamura -->
        <div class="descriptor-category" *ngIf="descriptors.tamura">
          <h4>üåä Descripteurs de Tamura</h4>
          <div class="tamura-descriptors">
            <div class="tamura-item" *ngIf="descriptors.tamura.coarseness !== undefined">
              <strong>Rugosit√© (Coarseness):</strong>
              <span class="value">{{ formatNumber(descriptors.tamura.coarseness) }}</span>
            </div>
            <div class="tamura-item" *ngIf="descriptors.tamura.contrast !== undefined">
              <strong>Contraste:</strong>
              <span class="value">{{ formatNumber(descriptors.tamura.contrast) }}</span>
            </div>
            <div class="tamura-item" *ngIf="descriptors.tamura.directionality !== undefined">
              <strong>Orientation (Directionality):</strong>
              <span class="value">{{ formatNumber(descriptors.tamura.directionality) }}</span>
            </div>
          </div>
        </div>

        <!-- Filtres de Gabor -->
        <div class="descriptor-category" *ngIf="descriptors.gabor">
          <h4>üåÄ Filtres de Gabor</h4>
          <div class="gabor-info">
            <p>64 descripteurs (4 √©chelles √ó 8 orientations √ó 2 statistiques)</p>
            <div class="gabor-stats" *ngIf="descriptors.gabor.length > 0">
              <div class="stat-item">
                <strong>Moyenne:</strong> {{ formatNumber(getArrayMean(descriptors.gabor)) }}
              </div>
              <div class="stat-item">
                <strong>√âcart-type:</strong> {{ formatNumber(getArrayStd(descriptors.gabor)) }}
              </div>
              <div class="stat-item">
                <strong>Min:</strong> {{ formatNumber(getArrayMin(descriptors.gabor)) }}
              </div>
              <div class="stat-item">
                <strong>Max:</strong> {{ formatNumber(getArrayMax(descriptors.gabor)) }}
              </div>
            </div>
            <details class="gabor-details">
              <summary>Voir tous les descripteurs Gabor ({{ descriptors.gabor.length }})</summary>
              <div class="gabor-values">
                <span *ngFor="let val of descriptors.gabor; let i = index" class="gabor-value" [title]="'Index ' + i">
                  {{ formatNumber(val) }}
                </span>
              </div>
            </details>
          </div>
        </div>

        <!-- Moments de Hu -->
        <div class="descriptor-category" *ngIf="descriptors.hu_moments">
          <h4>üî¢ Moments de Hu (7 invariants)</h4>
          <div class="hu-moments">
            <div class="hu-item" *ngFor="let moment of descriptors.hu_moments; let i = index">
              <strong>Moment {{ i + 1 }}:</strong>
              <span class="value">{{ formatNumber(moment) }}</span>
            </div>
          </div>
        </div>

        <!-- HOG -->
        <div class="descriptor-category" *ngIf="descriptors.hog">
          <h4>üìê Histogramme des orientations (HOG)</h4>
          <div class="hog-info">
            <p>{{ descriptors.hog.length }} descripteurs HOG calcul√©s</p>
            <div class="hog-stats" *ngIf="descriptors.hog.length > 0">
              <div class="stat-item">
                <strong>Moyenne:</strong> {{ formatNumber(getArrayMean(descriptors.hog)) }}
              </div>
              <div class="stat-item">
                <strong>√âcart-type:</strong> {{ formatNumber(getArrayStd(descriptors.hog)) }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="actions">
      <button class="back-button" (click)="goBack()">‚Üê Retour</button>
      <button class="download-button" (click)="downloadImage()">‚¨áÔ∏è T√©l√©charger</button>
    </div>
  </div>
</div>
