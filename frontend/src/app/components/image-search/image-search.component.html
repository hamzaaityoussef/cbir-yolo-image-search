<div class="search-container">
  <h2>Recherche d'Images Similaires</h2>
  <p class="description">
    Recherchez des images similaires en uploadant une nouvelle image ou en s√©lectionnant une image existante.
    Vous pouvez √©galement rechercher des images contenant un objet sp√©cifique.
  </p>

  <div class="search-form">
    <!-- Mode de recherche -->
    <div class="mode-selector">
      <label>
        <input type="radio" name="searchMode" value="upload" [(ngModel)]="searchMode" (change)="loadAvailableImages()">
        Upload d'une nouvelle image
      </label>
      <label>
        <input type="radio" name="searchMode" value="existing" [(ngModel)]="searchMode" (change)="loadAvailableImages()">
        Utiliser une image existante
      </label>
    </div>

    <!-- Mode Upload -->
    <div *ngIf="searchMode === 'upload'" class="upload-section">
      <div class="file-input-wrapper">
        <input 
          type="file" 
          id="queryFile" 
          accept="image/*"
          (change)="onQueryFileChange($event)">
        <label for="queryFile" class="file-label">
          üìÅ Choisir une image requ√™te
        </label>
      </div>
      <div *ngIf="queryFile" class="selected-file">
        <strong>Image s√©lectionn√©e:</strong> {{ queryFile.name }}
        ({{ (queryFile.size / 1024 / 1024).toFixed(2) }} MB)
      </div>
    </div>

    <!-- Mode Existing -->
    <div *ngIf="searchMode === 'existing'" class="existing-section">
      <div class="form-group">
        <label for="imageSelect">S√©lectionner une image:</label>
        <select 
          id="imageSelect" 
          [(ngModel)]="selectedImageId" 
          (change)="onImageSelect(selectedImageId)"
          class="form-select">
          <option value="">-- Choisir une image --</option>
          <option *ngFor="let img of availableImages" [value]="img.id">
            {{ img.filename }} ({{ img.objects_count || 0 }} objet(s))
          </option>
        </select>
      </div>

      <div *ngIf="selectedImage && selectedImage.objects_detected && selectedImage.objects_detected.length > 0" class="objects-section">
        <label>Rechercher un objet sp√©cifique (optionnel):</label>
        <div class="objects-list">
          <label *ngFor="let obj of selectedImage.objects_detected; let i = index" class="object-option">
            <input 
              type="radio" 
              name="objectId" 
              [value]="i" 
              [(ngModel)]="selectedObjectId">
            <span class="object-info">
              <strong>{{ obj.class }}</strong> 
              ({{ (obj.confidence * 100).toFixed(1) }}%)
            </span>
          </label>
          <label class="object-option">
            <input type="radio" name="objectId" value="" [(ngModel)]="selectedObjectId" [ngModelOptions]="{standalone: true}">
            <span>Image compl√®te</span>
          </label>
        </div>
      </div>
    </div>

    <!-- Param√®tres de recherche -->
    <div class="search-params">
      <div class="param-group">
        <label for="topK">Nombre de r√©sultats:</label>
        <input 
          type="number" 
          id="topK" 
          [(ngModel)]="topK" 
          min="1" 
          max="50" 
          class="param-input">
      </div>
      <div class="param-group">
        <label for="objectClassFilter">Filtrer par classe (optionnel):</label>
        <input 
          type="text" 
          id="objectClassFilter" 
          [(ngModel)]="objectClassFilter" 
          placeholder="ex: person, car, dog"
          class="param-input">
      </div>
    </div>

    <button 
      class="search-button" 
      (click)="search()" 
      [disabled]="loading || (searchMode === 'upload' && !queryFile) || (searchMode === 'existing' && !selectedImageId)">
      <span *ngIf="!loading">üîç Rechercher</span>
      <span *ngIf="loading">‚è≥ Recherche en cours...</span>
    </button>

    <div *ngIf="error" class="error-message">
      ‚ùå {{ error }}
    </div>
  </div>

  <!-- R√©sultats -->
  <div *ngIf="results.length > 0" class="results-section">
    <h3>R√©sultats de la recherche ({{ results.length }})</h3>
    
    <div *ngIf="queryInfo" class="query-info">
      <p><strong>Requ√™te:</strong> 
        <span *ngIf="queryInfo.type === 'upload'">Image upload√©e</span>
        <span *ngIf="queryInfo.type === 'existing'">Image existante (ID: {{ queryInfo.image_id }})</span>
        <span *ngIf="queryInfo.object_index !== undefined"> - Objet #{{ queryInfo.object_index }} ({{ queryInfo.object_class }})</span>
      </p>
    </div>

    <div class="results-grid">
      <div class="result-card" *ngFor="let result of results">
        <div class="result-image" (click)="viewImage(result)">
          <img [src]="'http://localhost:5000/download/' + result.id" 
               [alt]="result.filename"
               (error)="$event.target.src='assets/placeholder.png'">
          <div class="similarity-badge">
            Score: {{ result.similarity_score?.toFixed(4) || 'N/A' }}
          </div>
        </div>
        <div class="result-info">
          <h4>{{ result.filename }}</h4>
          <div class="result-meta">
            <span class="badge">{{ result.objects_count || 0 }} objet(s)</span>
            <span *ngIf="result.object_classes" class="classes">
              {{ result.object_classes.join(', ') }}
            </span>
          </div>
          <button class="view-btn" (click)="viewImage(result)">üëÅÔ∏è Voir</button>
        </div>
      </div>
    </div>
  </div>

  <div *ngIf="!loading && results.length === 0 && queryInfo" class="no-results">
    <p>üì≠ Aucun r√©sultat trouv√©.</p>
  </div>
</div>
